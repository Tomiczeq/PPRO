{% extends 'navigation.html' %}

{% block title %} {{ dashboard.name }} {% endblock %}

{% block content %}

    <div class="dashboard_navbar">
        <div class="dashboard_profile">
            <span>{{ dashboard.name }}</span>
        </div>
        <div class="dashboard_btns">
            <span id="explore_btn" class="icon_btn">
                <i class="fas fa-eye"></i>
            </span>
            <span id="move_btn" class="icon_btn">
                <i class="fas fa-expand-arrows-alt"></i>
            </span>
            <span class="icon_btn" id="add_row_btn">
                <i class="fas fa-plus"></i>
            </span>
            <span class="icon_btn" id="save_dashboard_btn">
                <i class="fas fa-save"></i>
            </span>
            <span class="icon_btn" id="dashboard_settings_btn">
                <i class="fas fa-cog"></i>
            </span>
            <span class="icon_btn" id="refresh_dashboard_btn">
                <i class="fas fa-sync"></i>
            </span>
        </div>
    </div>

    <div class="rows_container">
        <!-- {% for row in rows|sort(attribute='position') %}
            <div id="{{ row.id }}" class="row">
                <div class="row_header">{{ row.name }}</div>
                <div class="charts_container">
                    {% for chart in row.charts|sort(attribute='position') %}
                        <div id="{{ chart.id }}" class="chart">
                            <div class="chart_nav">
                                <span class="chart_name">{{ chart.name }}</span>
                                <a class="icon_btn", href="{{ url_for('dashboards.chart_page', chart_id=chart.id) }}">
                                    <i class="fas fa-cog"></i>
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %} -->
    </div>

{% endblock %}


{% block scripts %}
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
    <script>
        const dashboard_id = "{{ dashboard.id }}";
        
        function init_charts() {
            $.ajax({
                type: "GET",
                url: "/api/getDashboardCharts",
                data: {
                    dashboard_id: dashboard_id
                },
                success: function (rows_conf) {
                    var rows_container = document.querySelector('.rows_container');
                    rows_conf.forEach((row_conf) => {
                        console.log("aa");
                        var row = get_row(row_conf);
                        rows_container.appendChild(row);
                        $( function() {
                            qstring = "#" + row.id + " .charts_container";
                            console.log(qstring);
                            $(qstring).sortable();
                            $(qstring).disableSelection();
                        })
                    })
                    $( function() {
                        $(".rows_container").sortable();
                        $( "rows_container" ).disableSelection();
                    })
                    console.log("DOONE");
                },
                error: function (e) {
                    alert("error");
                },
            });
        }

        function get_row(row_conf) {
            var row = document.createElement('div');
            var row_header = document.createElement('div');
            var charts_container = document.createElement('div');


            row.classList.add('row');
            row_header.classList.add('row_header');
            charts_container.classList.add('charts_container');

            row.id = "row_" + row_conf.id;
            row_header.textContent = row_conf.name;
            row.appendChild(row_header);

            row_conf.charts.forEach((chart_conf) => {
                chart = draw_chart(chart_conf)
                charts_container.appendChild(chart);
            })

            row.appendChild(charts_container);
            return row;
        }

        function draw_chart(chart_conf) {
            var chart = document.createElement('div');
            var chart_nav = document.createElement('div');
            var chart_name = document.createElement('span');
            var chart_icon = document.createElement('a');
            var chart_icon_i = document.createElement('i');

            chart.classList.add('chart');
            chart_nav.classList.add('chart_nav');
            chart_name.classList.add('chart_nav');
            chart_icon.classList.add('icon_btn');
            chart_icon_i.classList.add('fas');
            chart_icon_i.classList.add('fa-cog');

            chart.id = "chart_" + chart_conf.id;
            chart_name.textContent = chart_conf.name;
            chart.style.width = chart_conf.width;
            chart.style.height = chart_conf.height;
            chart_icon.href = "/dashboards/chart/" + chart.id.replace(
                    "chart_", "");
            chart_icon.addEventListener("click", redirect_to_chart_settings);

            chart_icon.appendChild(chart_icon_i);
            chart_nav.appendChild(chart_name);
            chart_nav.appendChild(chart_icon);
            chart.appendChild(chart_nav)

            return chart;
        }

        init_charts();

        var add_row_btn = document.querySelector("#add_row_btn");
        add_row_btn.addEventListener("click", () => {
            $.ajax({
                type: "POST",
                url: "/api/createNewRow",
                data: {
                    dashboard_id: dashboard_id
                },
                success: function (row_conf) {
                    var row = get_row(row_conf);
                    var rows_container = document.querySelector(
                           ".rows_container");
                    rows_container.insertBefore(
                            row, rows_container.firstChild);
                },
                error: function (e) {
                    alert("error");
                },
            });
        })        

        // function add_new_chart(response) {
        //     var charts_container = document.querySelector('.charts_container');
        //     var chart = document.createElement('div');
        //     var chart_nav = document.createElement('div');
        //     var chart_name = document.createElement('span');
        //     var chart_icon = document.createElement('span');
        //     var chart_icon_i = document.createElement('i');

        //     chart.classList.add('chart');
        //     chart_nav.classList.add('chart_nav');
        //     chart_name.classList.add('chart_nav');
        //     chart_icon.classList.add('icon_btn');
        //     chart_icon_i.classList.add('fas');
        //     chart_icon_i.classList.add('fa-cog');

        //     chart_name.textContent = response.name;
        //     chart_icon.addEventListener("click", redirect_to_chart_settings);

        //     // chart_icon.addEventListener("click", redirect_to_chart_settings)

        //     chart_icon.appendChild(chart_icon_i);
        //     chart_nav.appendChild(chart_name);
        //     chart_nav.appendChild(chart_icon);
        //     chart.appendChild(chart_nav)
        //     charts_container.appendChild(chart);
        // }

        function redirect_to_chart_settings() {
            this.closest(".chart").id.replace("chart_", "");
        }

    </script>
{% endblock %}
